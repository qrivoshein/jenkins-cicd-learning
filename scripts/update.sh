#!/bin/bash

echo "üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—á–µ–±–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ CI/CD —Å Jenkins"
echo "==============================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ .env —Ñ–∞–π–ª–∞
if [ ! -f .env ]; then
    echo "‚ùå .env —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞ ./scripts/setup.sh"
    exit 1
fi

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
source .env

echo "üì¶ –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–µ–∫—Ç..."

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã..."
docker-compose down

# –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–∑—ã
echo "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º Docker –æ–±—Ä–∞–∑—ã..."
docker-compose pull

# –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
echo "üèóÔ∏è –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
docker-compose build --no-cache app-dev app-staging app-prod

# –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã..."
docker-compose up -d

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
echo "‚è≥ –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
sleep 30

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤..."
docker-compose ps

echo ""
echo "‚úÖ –ü—Ä–æ–µ–∫—Ç –æ–±–Ω–æ–≤–ª–µ–Ω!"
echo ""
echo "üîó –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:"
echo "- Jenkins: http://localhost:${JENKINS_PORT:-8080}"
echo "- GitLab: http://localhost:${GITLAB_PORT:-8081}"
echo "- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (Dev): http://localhost:${APP_DEV_PORT:-3000}"
echo "- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (Staging): http://localhost:${APP_STAGING_PORT:-3001}"
echo "- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (Prod): http://localhost:${APP_PROD_PORT:-3002}"
